<div class="relational-grid-container">
  <h2>GitHub Relationship Explorer</h2>
  
  <div class="header-controls">
    <mat-form-field appearance="outline" class="user-select">
      <mat-label>Active GitHub Integrations</mat-label>
      <mat-select [(ngModel)]="selectedUser" (selectionChange)="onUserChange()">
        <mat-option *ngFor="let user of users" [value]="user">
          {{ user.githubName || user.username }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="repository-select" *ngIf="repositories.length > 0">
      <mat-label>Repository</mat-label>
      <mat-select [(ngModel)]="selectedRepository" (selectionChange)="onRepositoryChange()">
        <mat-option *ngFor="let repo of repositories" [value]="repo">
          {{ repo.full_name || repo.name }}
        </mat-option>
      </mat-select>
      <mat-hint>Select a repository to view relationships</mat-hint>
    </mat-form-field>
  </div>

  <div class="filter-controls" *ngIf="currentRepo">
    <div class="filter-types">
      <mat-chip-listbox aria-label="Filter by type" [(ngModel)]="selectedFilterType" (change)="onFilterTypeChange($event)">
        <mat-chip-option value="All" [selected]="selectedFilterType === 'All'">
          All
          <span class="count-badge" *ngIf="totalRows > 0">({{totalRows}})</span>
        </mat-chip-option>
        <mat-chip-option value="Pull Requests" [selected]="selectedFilterType === 'Pull Requests'" color="accent">
          <mat-icon>merge_type</mat-icon> Pull Requests
          <span class="count-badge" *ngIf="totalPRs > 0">({{totalPRs}})</span>
        </mat-chip-option>
        <mat-chip-option value="Issues" [selected]="selectedFilterType === 'Issues'" color="warn">
          <mat-icon>bug_report</mat-icon> Issues
          <span class="count-badge" *ngIf="totalIssues > 0">({{totalIssues}})</span>
        </mat-chip-option>
      </mat-chip-listbox>
    </div>

    <div class="search-container">
      <mat-form-field appearance="outline" class="search-field">
        <mat-label>Search</mat-label>
        <input matInput [(ngModel)]="searchText" 
               placeholder="Search across all data" 
               (keyup)="onSearchInput()" 
               (keyup.enter)="onSearch()">
        <button *ngIf="searchText" matSuffix mat-icon-button aria-label="Clear" (click)="clearSearch()">
          <mat-icon>close</mat-icon>
        </button>
      </mat-form-field>
      
      <button mat-button (click)="resetGrid()">
        <mat-icon>refresh</mat-icon> Reset
      </button>
    </div>
  </div>

  <div *ngIf="loading" class="loading-spinner">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <div *ngIf="!loading && currentRepo" class="repo-info">
    <h3>
      <a [href]="currentRepo.repositoryFullName ? 'https://github.com/' + currentRepo.repositoryFullName : '#'" target="_blank">
        {{ currentRepo.repositoryFullName || currentRepo.repositoryName }}
      </a>
    </h3>
    <div class="repo-stats">
      <span class="stat-item">
        <mat-icon>merge_type</mat-icon> {{totalPRs}} Pull Requests
      </span>
      <span class="stat-item">
        <mat-icon>bug_report</mat-icon> {{totalIssues}} Issues
      </span>
    </div>
  </div>

  <div *ngIf="!loading && currentRepo && rowData.length > 0" class="grid-container" [style]="{'height': gridHeight}">
    <ag-grid-angular
      class="ag-theme-alpine"
      [rowData]="rowData"
      [columnDefs]="columnDefs"
      [defaultColDef]="defaultColDef"
      [pagination]="false"
      [rowSelection]="'multiple'"
      [masterDetail]="true"
      [detailRowHeight]="300"
      [detailCellRenderer]="getDetailCellRenderer()"
      [isRowMaster]="isRowMaster"
      [suppressRowClickSelection]="true"
      [enableCellTextSelection]="true"
      [suppressCellFocus]="true"
      [domLayout]="'normal'"
      [animateRows]="true"
      [rowHeight]="48"
  
      [components]="{
        avatarCellRenderer: avatarCellRenderer
      }"
      [autoSizeStrategy]="{
        type: 'fitCellContents'
      }"
      (gridReady)="onGridReady($event)"
      (filterChanged)="onFilterChanged($event)"
      (sortChanged)="onSortChanged($event)">
    </ag-grid-angular>

    <mat-paginator 
      [length]="totalRows"
      [pageSize]="pageSize"
      [pageSizeOptions]="pageSizeOptions"
      [pageIndex]="pageIndex"
      (page)="onPageChange($event)"
      *ngIf="totalRows > 0">
    </mat-paginator>
  </div>

  <div *ngIf="!loading && (!selectedUser)" class="no-data-message">
    <mat-card>
      <mat-card-content>
        <p>Please select a GitHub integration to view relationship data.</p>
      </mat-card-content>
    </mat-card>
  </div>

  <div *ngIf="!loading && selectedUser && repositories.length === 0" class="no-results-message">
    <mat-card>
      <mat-card-content>
        <p>No repositories found for the selected GitHub integration.</p>
      </mat-card-content>
    </mat-card>
  </div>

  <div *ngIf="!loading && selectedUser && repositories.length > 0 && !selectedRepository" class="no-results-message">
    <mat-card>
      <mat-card-content>
        <p>Please select a repository to view relationship data.</p>
      </mat-card-content>
    </mat-card>
  </div>

  <div *ngIf="!loading && currentRepo && rowData.length === 0" class="no-results-message">
    <mat-card>
      <mat-card-content>
        <p>No data found for the selected repository and filters.</p>
      </mat-card-content>
    </mat-card>
  </div>
</div>
